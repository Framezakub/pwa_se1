<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PWA Todo App</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2196f3" />

</head>
<body>
  <h1>📋 Todo PWA</h1>
  <input type="text" id="todo-input" placeholder="เพิ่มงานใหม่...">
  <button onclick="addTodo()">เพิ่ม</button>
  <ul id="todo-list"></ul>

  <button id="install-btn" style="display:none">📲 ติดตั้งแอป</button>
  <button onclick="updateCache()">🔄 อัพเดทแคช</button>
  <button onclick="testOffline()">📡 ทดสอบโหมดออฟไลน์</button>

  <script>
    // LocalStorage สำหรับ Todo
    const todoInput = document.getElementById('todo-input');
    const todoList = document.getElementById('todo-list');

    function loadTodos() {
      const todos = JSON.parse(localStorage.getItem('todos')) || [];
      todoList.innerHTML = '';
      todos.forEach((todo, index) => {
        const li = document.createElement('li');
        li.textContent = todo;
        li.onclick = () => removeTodo(index);
        todoList.appendChild(li);
      });
    }

    function addTodo() {
      const todos = JSON.parse(localStorage.getItem('todos')) || [];
      if (todoInput.value.trim()) {
        todos.push(todoInput.value);
        localStorage.setItem('todos', JSON.stringify(todos));
        todoInput.value = '';
        loadTodos();
      }
    }

    function removeTodo(index) {
      const todos = JSON.parse(localStorage.getItem('todos')) || [];
      todos.splice(index, 1);
      localStorage.setItem('todos', JSON.stringify(todos));
      loadTodos();
    }

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('SW registration failed:', err));
    }

    // ติดตั้งแอป
    let deferredPrompt;
    const installBtn = document.getElementById('install-btn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });

    installBtn.addEventListener('click', async () => {
      installBtn.style.display = 'none';
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`User response: ${outcome}`);
      deferredPrompt = null;
    });

    // ปุ่มอัพเดทแคช
    function updateCache() {
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ action: 'updateCache' });
        alert("Cache updated!");
      }
    }

    // ทดสอบออฟไลน์
    function testOffline() {
      alert('ลองปิดเน็ตแล้วรีเฟรชดูว่าแคชทำงานหรือไม่');
    }

    // แจ้งเตือนเมื่อ Offline / Online
    let wasOffline = false;
    window.addEventListener('offline', () => {
      wasOffline = true;
      alert('❌ ตอนนี้คุณออฟไลน์แล้ว');
    });

    window.addEventListener('online', () => {
      if (wasOffline) {
        wasOffline = false;
        alert('✅ กลับมาออนไลน์แล้ว');
      }
    });

    loadTodos();
  </script>
</body>
</html>
